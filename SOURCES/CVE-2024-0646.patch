From 5fce19840cb1c342ad92e836e3c665dac62f47f5 Mon Sep 17 00:00:00 2001
From: Joe Lawrence <joe.lawrence@redhat.com>
Date: Mon, 29 Jan 2024 16:20:42 -0500
Subject: [KPATCH CVE-2024-0646] kpatch fixes for CVE-2024-0646

Kernels:
5.14.0-362.8.1.el9_3
5.14.0-362.13.1.el9_3
5.14.0-362.18.1.el9_3


Kpatch-MR: https://gitlab.com/redhat/prdsc/rhel/src/kpatch/rhel-9/-/merge_requests/87
Changes since last build:
arches: x86_64 ppc64le
tls_sw.o: changed function: tls_sw_do_sendpage
---------------------------

Modifications: none

commit fff78656b1c56c98d416a4060698a6d8cab02ded
Author: Sabrina Dubroca <sdubroca@redhat.com>
Date:   Thu Jan 18 15:44:58 2024 +0100

    net: tls, update curr on splice as well

    JIRA: https://issues.redhat.com/browse/RHEL-22094
    CVE: CVE-2024-0646
    Y-Commit: 8ad16a75831dbe0ec7529c525e5ecb234b4925d1

    O-JIRA: https://issues.redhat.com/browse/RHEL-19065
    O-CVE: CVE-2024-0646
    Tested: selftests + reproducer

    Conflict: apply the changes to tls_sw_do_sendpage, missing the big
      splice rework (fe1e81d4f73b and 45e5be844ab6)

    commit c5a595000e2677e865a39f249c056bc05d6e55fd
    Author: John Fastabend <john.fastabend@gmail.com>
    Date:   Wed Dec 6 15:27:05 2023 -0800

        net: tls, update curr on splice as well

        The curr pointer must also be updated on the splice similar to how
        we do this for other copy types.

        Fixes: d829e9c4112b ("tls: convert to generic sk_msg interface")
        Signed-off-by: John Fastabend <john.fastabend@gmail.com>
        Reported-by: Jann Horn <jannh@google.com>
        Link: https://lore.kernel.org/r/20231206232706.374377-2-john.fastabend@gmail.com
        Signed-off-by: Jakub Kicinski <kuba@kernel.org>

    Signed-off-by: Sabrina Dubroca <sdubroca@redhat.com>
    Signed-off-by: Patrick Talbert <ptalbert@redhat.com>
    Signed-off-by: Rado Vrbovsky <rvrbovsk@redhat.com>

Signed-off-by: Joe Lawrence <joe.lawrence@redhat.com>
---
 net/tls/tls_sw.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/net/tls/tls_sw.c b/net/tls/tls_sw.c
index b03026b4a9c9..be8f4f01b7ec 100644
--- a/net/tls/tls_sw.c
+++ b/net/tls/tls_sw.c
@@ -1209,6 +1209,8 @@ static int tls_sw_do_sendpage(struct sock *sk, struct page *page,
 		}
 
 		sk_msg_page_add(msg_pl, page, copy, offset);
+		msg_pl->sg.copybreak = 0;
+		msg_pl->sg.curr = msg_pl->sg.end;
 		sk_mem_charge(sk, copy);
 
 		offset += copy;
-- 
2.43.0


